name: Security Guardrails

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # JOB 1: SECRET SCANNING (New!)
  secrets-scan:
    runs-on: ubuntu-latest
    name: Detect Hardcoded Secrets
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Important: Fetch full history to check past commits

      - name: Gitleaks Scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: free

  # JOB 2: INFRASTRUCTURE SCANNING (Your existing Checkov job)
  checkov-scan:
    runs-on: ubuntu-latest
    name: Run Checkov Scanner
    needs: secrets-scan # Optional: Make Checkov wait for Secrets to pass
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Run Checkov Scanner
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/aws
          external_checks_dirs: policies
          check: CUSTOM_AWS_1
          quiet: false
          soft_fail: false
# JOB 3: CONTAINER SECURITY (New!)
  container-security:
    runs-on: ubuntu-latest
    name: Scan Container Image
    needs: secrets-scan # Wait for secrets check to pass
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: docker build -t my-secure-app:${{ github.sha }} .

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'my-secure-app:${{ github.sha }}'
          format: 'table'
          exit-code: '1' # Fail the build if vulnerabilities are found
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
# JOB 4: POLICY AS CODE (OPA/Rego)
  opa-policy-check:
    runs-on: ubuntu-latest
    name: Enforce OPA Policies
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Install Conftest
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v0.45.0/conftest_0.45.0_Linux_x86_64.tar.gz
          tar xzf conftest_0.45.0_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin

      - name: Run OPA Policies against Terraform
        # FIX: Put flags (-p and --input) BEFORE the file path
        run: conftest test -p policies/allowed_instances.rego --input hcl infrastructure/aws/main.tf
